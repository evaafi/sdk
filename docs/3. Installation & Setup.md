# Installation & Setup

## Table of Contents

1. [Installation via npm or yarn](#installation-via-npm-or-yarn)
2. [Environment Configuration](#environment-configuration)
3. [SDK Initialization](#sdk-initialization)
4. [PricesCollector Configuration](#pricescollector-configuration)
5. [Common Setup Issues and Troubleshooting](#common-setup-issues-and-troubleshooting)

## Installation via npm or yarn

To integrate the EVAA SDK into your development environment, install it using either npm or yarn. The package name is `@evaafi/sdk`.

**Installation Commands:**

-   Using npm:

```bash
  npm install @evaafi/sdk
```

-   Using yarn:

```bash
  yarn add @evaafi/sdk
```

The SDK has several peer dependencies that must be installed separately to ensure compatibility:

-   `@ton/core` (version >=0.56.0)
-   `@tonconnect/sdk` (version >=3.0.0)
-   `crypto-js` (version >=4.2.0)

These are listed in the `peerDependencies` field of the `package.json` file. Failure to install compatible versions may result in runtime errors or module resolution issues.

**Section sources**

-   [package.json](file://package.json#L38-L43)

## Environment Configuration

The EVAA SDK uses environment variables for configuration, particularly for API endpoints and network-specific settings. It integrates with the `dotenv` package to load configuration from a `.env` file.

### Creating the .env File

Create a `.env` file in your project root directory to store sensitive or environment-specific variables. Example:

```env
RPC_API_KEY_MAINNET=your_mainnet_api_key
RPC_API_KEY_TESTNET=your_testnet_api_key
```

The `.env` file is git-ignored by default (as noted in `AGENTS.md`), ensuring secrets are not committed to version control.

### Loading Environment Variables

Use the `dotenv` package to load environment variables:

```ts
import dotenv from 'dotenv';
dotenv.config();
```

This enables access to environment variables via `process.env.RPC_API_KEY_MAINNET`, etc.

### Required Configuration Variables

| Variable              | Description                               |
| --------------------- | ----------------------------------------- |
| `RPC_API_KEY_MAINNET` | API key for TON mainnet JSON-RPC endpoint |
| `RPC_API_KEY_TESTNET` | API key for TON testnet JSON-RPC endpoint |

These are used when initializing the `TonClient` for interacting with the blockchain.

**Section sources**

-   [AGENTS.md](file://AGENTS.md#L37-L40)
-   [package.json](file://package.json#L44-L46)

## SDK Initialization

The EVAA SDK provides contract wrappers for interacting with the protocol's master contracts. The two primary classes are `EvaaMasterClassic` and `EvaaMasterPyth`, which extend `AbstractEvaaMaster`.

### Importing SDK Components

The SDK supports both ESM and CommonJS module systems.

**ESM (ES6+):**

```ts
import { EvaaMasterClassic, EvaaMasterPyth } from '@evaafi/sdk';
```

**CommonJS:**

```js
const { EvaaMasterClassic, EvaaMasterPyth } = require('@evaafi/sdk');
```

These classes are re-exported from `src/index.ts`, which serves as the main entry point.

### Initializing Master Contracts

To interact with the protocol, instantiate the appropriate master contract with configuration parameters.

#### Classic Oracle Mode

```ts
import { TonClient } from '@ton/ton';
import { EvaaMasterClassic, MAINNET_CLASSIC_POOL_CONFIG } from '@evaafi/sdk';

const client = new TonClient({
    endpoint: 'https://toncenter.com/api/v2/jsonRPC',
    apiKey: process.env.RPC_API_KEY_MAINNET,
});

const master = client.open(
    new EvaaMasterClassic({
        poolConfig: MAINNET_CLASSIC_POOL_CONFIG,
    }),
);

await master.getSync(); // Synchronize contract state
```

#### Pyth Oracle Mode

```ts
import { TonClient } from '@ton/ton';
import { EvaaMasterPyth, MAINNET_PYTH_V8_TOB_POOL_CONFIG } from '@evaafi/sdk';

const client = new TonClient({
    endpoint: 'https://toncenter.com/api/v2/jsonRPC',
    apiKey: process.env.RPC_API_KEY_MAINNET,
});

const master = client.open(
    new EvaaMasterPyth({
        poolConfig: MAINNET_PYTH_V8_TOB_POOL_CONFIG,
    }),
);

await master.getSync(); // Synchronize contract state
```

The `getSync()` method fetches and parses the contract's current state using the appropriate oracle parser (`ClassicOracleParser` or `PythOracleParser`).

**Section sources**

-   [src/index.ts](file://src/index.ts#L1-L45)
-   [src/contracts/ClassicMaster.ts](file://src/contracts/ClassicMaster.ts#L60-L65)
-   [src/contracts/PythMaster.ts](file://src/contracts/PythMaster.ts#L39-L75)

## PricesCollector Configuration

The `PricesCollector` class is responsible for aggregating price data from multiple sources to ensure reliability and accuracy.

### Initialization

```ts
import { PricesCollector } from '@evaafi/sdk';
import { ORACLES_MAINNET } from '@evaafi/sdk/constants/general';
import { MAINNET_POOL_ASSETS_CONFIG } from '@evaafi/sdk/constants/pools';

const collector = new PricesCollector({
    poolAssetsConfig: MAINNET_POOL_ASSETS_CONFIG,
    minimalOracles: 3,
    evaaOracles: ORACLES_MAINNET,
});
```

### Configuration Options

| Option                   | Type                   | Description                                       |
| ------------------------ | ---------------------- | ------------------------------------------------- |
| `poolAssetsConfig`       | `PoolAssetsConfig`     | List of supported assets in the pool              |
| `minimalOracles`         | `number`               | Minimum number of valid oracle responses required |
| `evaaOracles`            | `ExtendedEvaaOracle[]` | List of oracle NFTs for signature verification    |
| `sourcesConfig`          | `PriceSourcesConfig`   | Optional configuration for price source endpoints |
| `additionalPriceSources` | `PriceSource[]`        | Optional list of custom price sources             |

### Adding Custom Price Sources

You can extend the default price sources (Backend and ICP) by providing additional implementations.

```ts
import { BackendPriceSource } from '@evaafi/sdk/prices/sources';

const customSource = new BackendPriceSource('custom-oracle.example.com', ORACLES_MAINNET);
const collector = new PricesCollector({
    poolAssetsConfig: MAINNET_POOL_ASSETS_CONFIG,
    minimalOracles: 3,
    evaaOracles: ORACLES_MAINNET,
    additionalPriceSources: [customSource],
});
```

### Timeout Settings

Timeouts are managed via the `FetchConfig` object, which is passed to price fetching methods. The default timeout is defined in `DefaultFetchConfig` within `src/utils/utils.ts`.

```ts
import { DefaultFetchConfig } from '@evaafi/sdk/utils/utils';

const prices = await collector.getPrices(DefaultFetchConfig);
```

The `proxyFetchRetries` utility handles retries with exponential backoff in case of network failures.

**Section sources**

-   [src/prices/PricesCollector.ts](file://src/prices/PricesCollector.ts#L25-L163)
-   [src/prices/sources/Backend.ts](file://src/prices/sources/Backend.ts#L0-L30)
-   [src/prices/sources/Icp.ts](file://src/prices/sources/Icp.ts#L0-L29)
-   [src/prices/sources/PriceSource.ts](file://src/prices/sources/PriceSource.ts#L0-L35)
-   [src/utils/utils.ts](file://src/utils/utils.ts#L104-L141)

## Common Setup Issues and Troubleshooting

### Version Conflicts with @ton/core

Ensure that the installed version of `@ton/core` is compatible (>=0.56.0). Mismatched versions can cause type errors or runtime failures.

**Solution:** Explicitly install the correct version:

```bash
npm install @ton/core@0.56.0
```

### Missing Peer Dependencies

If peer dependencies are not installed, the SDK may fail to load or throw runtime errors.

**Solution:** Install all peer dependencies:

```bash
npm install @ton/core @tonconnect/sdk crypto-js
```

### Incorrect Network Parameters

Using testnet configuration with mainnet endpoints (or vice versa) will result in invalid state or failed transactions.

**Solution:** Double-check pool configuration constants:

-   Use `MAINNET_CLASSIC_POOL_CONFIG` or `MAINNET_PYTH_V8_TOB_POOL_CONFIG` for mainnet
-   Use corresponding testnet configurations for testnet

### Initialization Failures

If `getSync()` fails, it may be due to:

-   Invalid RPC endpoint or API key
-   Network connectivity issues
-   Contract address mismatch

**Troubleshooting Tips:**

1. Verify the RPC endpoint and API key in `.env`
2. Check network connectivity
3. Ensure the `poolConfig` matches the target network
4. Confirm the contract address in the pool config is correct

### Connection Errors

Connection errors often stem from misconfigured `TonClient` or blocked API keys.

**Example Fix:**

```ts
const client = new TonClient({
    endpoint: 'https://toncenter.com/api/v2/jsonRPC',
    apiKey: process.env.RPC_API_KEY_MAINNET || '', // Ensure fallback
});
```

Always validate that environment variables are loaded correctly before initializing the client.
